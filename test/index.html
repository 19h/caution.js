<!DOCTYPE html>
<html>
<head>
	<link rel="stylesheet" href="modules/test-runner-html.css"/>
</head>
<body>
	<script>var VERSION = 'dev'</script>
	<script src="../src/caution-inline.js"></script>
	<script src="../modules/caution.js"></script>
	</script src="tests.js"></script>
	<script>
	define(['caution'], function (caution) {
		caution.DEBUG = true;
		caution.addSafe(function () {
			// Accept everything
			return true;
		});
		caution.addUrls(['../modules/{}.js', 'modules/{}.js']);
		caution.addUrls(function (module, versions) {
			return versions.map(function (version) {
				return 'http://cdnjs.cloudflare.com/ajax/libs/' + module + '/' + version + '/' + module + '.js'
			});
		});
		caution.missingModules(function (moduleName) {
			caution.load(moduleName);
		});
		
		caution.load('chai', ['1.10.0']);
	});
	
	function runTests() {
		define(['caution', 'chai', 'test-runner', 'test-runner-html'], function (caution, chai, TestRunner, domUI) {
			document.title = "Caution.js tests";
		
			var targetDiv = document.createElement('div');
			targetDiv.className = 'test-set';
			document.body.appendChild(targetDiv);

			var runner = new TestRunner();
		
			window.chai = chai;
			window.assert = chai.assert;
		
			caution.get('test-list.json', true, function (error, listJson) {
				if (error) throw error;
				var list = JSON.parse(listJson);

				runner.load(list, function (error) {
					if (error) throw error;
			
					domUI(runner, targetDiv);

					runner.run(function (report) {
						console.log('Finished tests:', report);
					});
				});
			});
		});
	}
	
	var chosen = false;
	function actAsParent() {
		if (chosen) return;
		chosen = true;

		var iframe = document.createElement('iframe');
		iframe.width = '100%';
		iframe.height = '100%';
		iframe.src = location.href;
		iframe.style.opacity = 0.5;
		document.body.appendChild(iframe);
		console.log('acting as parent');

		var handler = function (event) {
			window.loadedMessage = event;
			if (event.source === iframe.contentWindow && event.data === 'loaded') {
				console.log('child loaded');
				iframe.contentWindow.postMessage({
					actAsChild: {suite: 0, test: 0}
				}, '*');
			}
		};
		window.onmessage = handler;
	}
	function actAsChild(instructions) {
		if (chosen) return;
		chosen = true;
		console.log('acting as child:', instructions);
		//runTests();
	}
	
	if (!window.parent || window.parent === window) {
		actAsParent();
	} else {
		window.onmessage = function (event) {
			if (event.data && event.data.actAsChild) {
				actAsChild(event.data.actAsChild);
			}
		};
		window.parent.postMessage('loaded', '*');
		setTimeout(actAsParent, 1000);
	}
	
	</script>
</body>
</html>